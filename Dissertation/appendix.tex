\chapter{LFAlloc}\label{app:A}

\newenvironment{codebr}{\captionsetup{type=listing}}{}

\section{Код аллокатора}


\begin{codebr}
	
	\begin{minted}[linenos, frame=leftline, fontsize=\tiny]{c++}
    
class LockFreeStack {
 public:
  void Push(Node* node) {
    Node* current_top = top_.load();
    do {
      node->next_.store(current_top);
    } while (!top_.compare_exchange_weak(current_top, node));
  }

  void Append(Node* head) {
    if (head == nullptr) {
      return;
    }

    Node* tail = head;
    Node* next = tail->next_.load();
    while (next != nullptr) {
      tail = next;
      next = tail->next_.load();
    }

    Node* prev_top = top_.load();
    do {
      tail->next_ = prev_top;
    } while (!top_.compare_exchange_weak(prev_top, head));
  }

  Node* Top() {
    return top_.load();
  }

  Node* Pop() {
    Node* curr_top = top_.load();
    Node* next_top;
    do {
      if (curr_top == nullptr) {
        break;
      }
      next_top = curr_top->next_.load();
    } while (!top_.compare_exchange_weak(curr_top, next_top));
    return curr_top;
  }

  bool TryClear(Node* expected) {
    Node* desired = nullptr;
    return top_.compare_exchange_strong(expected, desired);
  }

  StateDescription DescribeState(const std::string& name = "LFStack") {
    StateDescription d{name};
    auto head = top_.load();
    std::stringstream chain;
    while (head != nullptr) {
      chain << "-> " << head->GetLabel();
      head = head->next_;
    }
    d.Add("Blocks", chain.str());
    return d;
  }

 private:
  twist::stdlike::atomic<Node*> top_{nullptr};
};

//////////////////////////////////////////////////////////////////

class LFAllocator {
 public:
  LFAllocator(MemoryPool& pool) {
    twist::checker::ForkGuard guard;
    for (auto& node : pool.GetNodes()) {
      node.Acquire();
      item_list_.Push(&node);
    }
  }

  void Free(Node* node) {
    if (allocation_count_.load() == 0) {
      item_list_.Push(node);
    } else {
      pending_list_.Push(node);
    }
  }

  bool Alloc() {
    Node* pending_head = pending_list_.Top();

    if (allocation_count_.fetch_add(1) == 0) {
      if (pending_head != nullptr
          && pending_list_.TryClear(pending_head)) {
        auto head = pending_head;

        pending_head = pending_head->next_.load();
        head->Release();

        item_list_.Append(pending_head);
        allocation_count_.fetch_sub(1);

        return true;
      }
    }

    auto node = item_list_.Pop();
    if (node != nullptr) {
      node->Release();
    }

    allocation_count_.fetch_sub(1);

    return node != nullptr;
  }

  Node* Top() {
    return item_list_.Top();
  }

  Node* TopPending() {
    return item_list_.Top();
  }

  StateDescription DescribeState() {
    StateDescription d{"LFStack"};
    d.Add(item_list_.DescribeState("Head"));
    d.Add(pending_list_.DescribeState("Pending"));
    d.Add("allocation_count_", allocation_count_.load());
    return d;
  }

 private:
  LockFreeStack item_list_;
  LockFreeStack pending_list_;

  twist::stdlike::atomic<int> allocation_count_{0};
};

\end{minted}
%\caption{Код LFALLoc.}
	
\end{codebr}

\section{Вспомогательный код (валидация памяти)}

\begin{codebr}
	
\begin{minted}[linenos, frame=leftline, escapeinside=||, fontsize=\tiny]{c++}

struct Node {
  twist::stdlike::atomic<Node*> next_{nullptr};
  bool free_{true};
  std::string label_;

  bool IsReleased() const {
    return free_;
  }

  void Release() {
    free_ = true;
  }

  void Acquire() {
    free_ = false;
  }

  void SetLabel(const std::string& name) {
    std::ostringstream os;
    os << name << " (" << std::hex << this << std::dec << ") ";
    label_ = os.str();
  }

  std::string GetLabel() const {
    return label_;
  }
};

class MemoryPool {
 public:
  MemoryPool(size_t count) {
    nodes_ = std::vector<Node>{count};
    char name = 'A';

    for (auto it = nodes_.rbegin(); it != nodes_.rend(); ++it) {
      it->SetLabel(std::string(1, name++));
    }
  }

  std::vector<Node>& GetNodes() {
    return nodes_;
  }

  size_t ReleasedCount() const {
    size_t cnt = 0;
    for (auto& node : nodes_) {
      if (node.IsReleased()) {
        ++cnt;
      }
    }
    return cnt;
  }

  Node* Get(size_t index) {
    return &nodes_[index];
  }

  Node* Acquire(size_t index) {
    for (auto& node : nodes_) {
      if (node.IsReleased()) {
        if (index == 0) {
          node.Acquire();
          return &node;
        }
        |-{}-|index;
      }
    }
    TWIST_UNREACHABLE();
  }

  StateDescription DescribeState(const std::string& name = "Memory") {
    StateDescription description{name};
    for (auto& node : nodes_) {
      description.Add(node.GetLabel(), !node.free_);
    }
    return description;
  }

 private:
  std::vector<Node> nodes_;
};

\end{minted}
%\caption{Вспомогательный код.}
	
\end{codebr}

\section{Код теста}\label{app:A3}




\begin{codebr}
	
	\begin{minted}[linenos, frame=leftline, fontsize=\tiny]{c++}

TEST_SUITE(AllocLockFreeStack) {
  SIMPLE_CHECKER_TEST(Spec) {
    MemoryPool pool{3};
    LFAllocator stack{pool};

    Trace("/tmp/alloc_lfstack/aba.log");

    PrintState([&stack, &pool]() {
      StateDescription d{"LFAlloc"};
      d.Add(stack.DescribeState());
      d.Add(pool.DescribeState());
      return d;
    });

    AddInvariant([&stack]() -> std::pair<bool, std::string> {
      ForkGuard guard;

      auto check_list = [](Node* node) {
        while (node != nullptr) {
          if (node->IsReleased()) {
            return false;
          }
          node = node->next_.load();
        }
        return true;
      };

      if (!check_list(stack.Top())) {
        return {false, "ItemList: assertion failed"};
      }

      if (!check_list(stack.TopPending())) {
        return {false, "PendingList: assertion failed"};
      }

      return {true, ""};
    }).ExpectFail();

    auto worker = [&stack, &pool]() {
      while (true) {
        size_t available = pool.ReleasedCount();
        int node_index = Random(available + 1);
        if (node_index == 0) {
          SHOW_NOTE("Alloc(): before");
          stack.Alloc();
          SHOW_NOTE("Alloc(): after");
        } else {
          SHOW_NOTE("Free(): before");
          Node* to_free = pool.Acquire(node_index - 1);
          stack.Free(to_free);
          SHOW_NOTE("Free(): after");
        }
      }
    };

    std::vector<twist::stdlike::thread> threads;
    for (size_t i = 0; i < 3; ++i) {
      threads.emplace_back(worker);
    }

    for (auto& th : threads) {
      th.join();
    }
  }
}

	\end{minted}
	%\caption{Тест LFALLoc.}
	
\end{codebr}

\pagebreak

\section{Траектория}\label{app:trace}

\begin{adjustwidth}{-3.3cm}{-1cm}

\definecolor{yellow}{rgb}{1.0, 0.75, 0.0}

%\newfontfamily\myfont[<font features>]{<name of font>}

\newenvironment{allintypewriter}{\ttfamily}{\par}

%\setlength{\columnseprule}{0.5pt}
\def\columnseprulecolor{\color{gray}}
\setlength\columnsep{0pt}

\begin{allintypewriter}
%\fontfamily{ptm}\selectfont 

\noindent
\obeyspaces
\begin{multicols*}{2}
\noindent	
\obeyspaces
\begin{lstlisting}[numbers=none]

<@\textcolor{yellow}{==========================================================================================}@>
                                 <@\textcolor{yellow}{THREAD SWITCHING HISTORY}@>
<@\textcolor{yellow}{==========================================================================================}@>

0 1 1 1 1 1 1 21 2 1 1 2 2 2 2 2 3 3 2 2 20 2 3 1 1 1 2 2 1 11 1 1 2 1 11 1 1 1 1 1 1 1 1 
1 3 3 3 3 3 3 2 

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 1 (THREAD 0)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

STATE: STARTING

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

Joining thread 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

STATE: RUNNING -> SUSPENDED

Blocked by event awaiting (wait queue: 0)

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 2 (THREAD 1)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

STATE: STARTING

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

Alloc(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 0
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Top()
  38:   Node* Top() {
> <@\textcolor{magenta}{39:     return top\_.load();}@>
  40:   }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  96:     // auto keep_count = pending_count_.load();
> <@\textcolor{magenta}{97:     Node* pending\_head = pending\_list\_.Top();}@>

Local variables: 
pending_head = 0x7fc21bc8cea0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 2}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 0
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_add: prev = 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 3}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 1}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  42:   Node* Pop() {
> <@\textcolor{magenta}{43:     Node* curr\_top = top\_.load();}@>
  44:     Node* next_top;

Local variables: 
curr_top = 0x100000005
next_top = 0x100000000

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96070

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 4}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  48:       }
> <@\textcolor{magenta}{49:       next\_top = curr\_top->next\_.load();}@>
  50:     } while (!top_.compare_exchange_weak(curr_top, next_top));

Local variables: 
curr_top = 0x7fc21bc96070
next_top = 0x100000000

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96040

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 5}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  49:       next_top = curr_top->next_.load();
> <@\textcolor{magenta}{50:     \} while (!top\_.compare\_exchange\_weak(curr\_top, next\_top));}@>
  51:     return curr_top;

Local variables: 
curr_top = 0x7fc21bc96070
next_top = 0x7fc21bc96040

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_weak(): succeeded = 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			<@\textcolor{red}{[*] Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) }@>
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		<@\textcolor{red}{[*] A (0x7fc21bc96070) : 0}@>
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{120:     allocation\_count\_.fetch\_sub(1);}@>

Local variables: 
pending_head = 0x0
node = 0x7fc21bc96070

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 3 (THREAD 2)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

STATE: STARTING

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

Free(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		<@\textcolor{red}{[*] A (0x7fc21bc96070) : 1}@>
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  87:   void Free(Node* node) /*__attribute__((noinline))*/ {
> <@\textcolor{magenta}{88:     if (allocation\_count\_.load() == 0) \{}@>
  89:       item_list_.Push(node);

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  13:   void Push(Node* node) {
> <@\textcolor{magenta}{14:     Node* current\_top = top\_.load();}@>
  15:     do {

Local variables: 
current_top = 0x100413133

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 4 (THREAD 1)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{120:     allocation\_count\_.fetch\_sub(1);}@>

Local variables: 
pending_head = 0x0
node = 0x7fc21bc96070

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_sub(): prev = 1

Alloc(): after

Alloc(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 0}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Top()
  38:   Node* Top() {
> <@\textcolor{magenta}{39:     return top\_.load();}@>
  40:   }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  96:     // auto keep_count = pending_count_.load();
> <@\textcolor{magenta}{97:     Node* pending\_head = pending\_list\_.Top();}@>

Local variables: 
pending_head = 0x7fc21bc8cea0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 0
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 5 (THREAD 2)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  13:   void Push(Node* node) {
> <@\textcolor{magenta}{14:     Node* current\_top = top\_.load();}@>
  15:     do {

Local variables: 
current_top = 0x100413133

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 0
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  15:     do {
> <@\textcolor{magenta}{16:       node->next\_.store(current\_top);}@>
  17:     } while (!top_.compare_exchange_weak(current_top, node));

Local variables: 
current_top = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 2}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 0
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  16:       node->next_.store(current_top);
> <@\textcolor{magenta}{17:     \} while (!top\_.compare\_exchange\_weak(current\_top, node));}@>
  18:   }

Local variables: 
current_top = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_weak(): succeeded = 1

Free(): after

Alloc(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 3}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			<@\textcolor{red}{[*] Blocks: -> A (0x7fc21bc96070) }@>
		    }

		    allocation_count_: 0
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Top()
  38:   Node* Top() {
> <@\textcolor{magenta}{39:     return top\_.load();}@>
  40:   }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  96:     // auto keep_count = pending_count_.load();
> <@\textcolor{magenta}{97:     Node* pending\_head = pending\_list\_.Top();}@>

Local variables: 
pending_head = 0x7fb80b3baea0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96070

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 4}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) 
		    }

		    allocation_count_: 0
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_add: prev = 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 1}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::TryClear(Node*)
  55:     Node* desired = nullptr;
> <@\textcolor{magenta}{56:     return top\_.compare\_exchange\_strong(expected, desired);}@>
  57:   }

Local variables: 
desired = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/
> <@\textcolor{magenta}{101:           \&\& pending\_list\_.TryClear(pending\_head)) \{}@>
  102:         auto head = pending_head;

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 6 (THREAD 3)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

STATE: STARTING

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

Alloc(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) 
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Top()
  38:   Node* Top() {
> <@\textcolor{magenta}{39:     return top\_.load();}@>
  40:   }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  96:     // auto keep_count = pending_count_.load();
> <@\textcolor{magenta}{97:     Node* pending\_head = pending\_list\_.Top();}@>

Local variables: 
pending_head = 0x7fb80b3b1ea0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96070

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) 
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 7 (THREAD 2)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::TryClear(Node*)
  55:     Node* desired = nullptr;
> <@\textcolor{magenta}{56:     return top\_.compare\_exchange\_strong(expected, desired);}@>
  57:   }

Local variables: 
desired = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/
> <@\textcolor{magenta}{101:           \&\& pending\_list\_.TryClear(pending\_head)) \{}@>
  102:         auto head = pending_head;

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_strong(): succeeded = 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			<@\textcolor{red}{[*] Blocks: }@>
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{104:         pending\_head = pending\_head->next\_.load();}@>
  105:         head->Release();

Local variables: 
head = 0x7fc21bc96070
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 2}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 1
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		<@\textcolor{red}{[*] A (0x7fc21bc96070) : 0}@>
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  108:         // pending_count_.fetch_add(1);
> <@\textcolor{magenta}{109:         allocation\_count\_.fetch\_sub(1);}@>

Local variables: 
head = 0x7fc21bc96070
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_sub(): prev = 1

Alloc(): after

Alloc(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 3}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 0}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Top()
  38:   Node* Top() {
> <@\textcolor{magenta}{39:     return top\_.load();}@>
  40:   }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  96:     // auto keep_count = pending_count_.load();
> <@\textcolor{magenta}{97:     Node* pending\_head = pending\_list\_.Top();}@>

Local variables: 
pending_head = 0x7fb80b3baea0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 0
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 8 (THREAD 3)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_add: prev = 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 1}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::TryClear(Node*)
  55:     Node* desired = nullptr;
> <@\textcolor{magenta}{56:     return top\_.compare\_exchange\_strong(expected, desired);}@>
  57:   }

Local variables: 
desired = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/
> <@\textcolor{magenta}{101:           \&\& pending\_list\_.TryClear(pending\_head)) \{}@>
  102:         auto head = pending_head;

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                     <@\textcolor{yellow}{RUN 9 (THREAD 1)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_add: prev = 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 2}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  42:   Node* Pop() {
> <@\textcolor{magenta}{43:     Node* curr\_top = top\_.load();}@>
  44:     Node* next_top;

Local variables: 
curr_top = 0x100000005
next_top = 0x100000001

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96040

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 2}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  48:       }
> <@\textcolor{magenta}{49:       next\_top = curr\_top->next\_.load();}@>
  50:     } while (!top_.compare_exchange_weak(curr_top, next_top));

Local variables: 
curr_top = 0x7fc21bc96040
next_top = 0x100000001

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96010

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  49:       next_top = curr_top->next_.load();
> <@\textcolor{magenta}{50:     \} while (!top\_.compare\_exchange\_weak(curr\_top, next\_top));}@>
  51:     return curr_top;

Local variables: 
curr_top = 0x7fc21bc96040
next_top = 0x7fc21bc96010

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                    <@\textcolor{yellow}{RUN 10 (THREAD 2)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_add: prev = 2

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 3}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  42:   Node* Pop() {
> <@\textcolor{magenta}{43:     Node* curr\_top = top\_.load();}@>
  44:     Node* next_top;

Local variables: 
curr_top = 0x100000005
next_top = 0x100000002

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96040

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> B (0x7fc21bc96040) -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  48:       }
> <@\textcolor{magenta}{49:       next\_top = curr\_top->next\_.load();}@>
  50:     } while (!top_.compare_exchange_weak(curr_top, next_top));

Local variables: 
curr_top = 0x7fc21bc96040
next_top = 0x100000002

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                    <@\textcolor{yellow}{RUN 11 (THREAD 1)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  49:       next_top = curr_top->next_.load();
> <@\textcolor{magenta}{50:     \} while (!top\_.compare\_exchange\_weak(curr\_top, next\_top));}@>
  51:     return curr_top;

Local variables: 
curr_top = 0x7fc21bc96040
next_top = 0x7fc21bc96010

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_weak(): succeeded = 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			<@\textcolor{red}{[*] Blocks: -> C (0x7fc21bc96010) }@>
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		<@\textcolor{red}{[*] B (0x7fc21bc96040) : 0}@>
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{120:     allocation\_count\_.fetch\_sub(1);}@>

Local variables: 
pending_head = 0x0
node = 0x7fc21bc96040

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_sub(): prev = 3

Alloc(): after

Free(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 2}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 2}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		<@\textcolor{red}{[*] B (0x7fc21bc96040) : 1}@>
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  87:   void Free(Node* node) /*__attribute__((noinline))*/ {
> <@\textcolor{magenta}{88:     if (allocation\_count\_.load() == 0) \{}@>
  89:       item_list_.Push(node);

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96040
available = 0x2
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 2

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 3}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  13:   void Push(Node* node) {
> <@\textcolor{magenta}{14:     Node* current\_top = top\_.load();}@>
  15:     do {

Local variables: 
current_top = 0x200413133

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96040
available = 0x2
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  15:     do {
> <@\textcolor{magenta}{16:       node->next\_.store(current\_top);}@>
  17:     } while (!top_.compare_exchange_weak(current_top, node));

Local variables: 
current_top = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96040
available = 0x2
node_index = 0x0

<@\textcolor{yellow}{==========================================================================================}@>
                                    <@\textcolor{yellow}{RUN 12 (THREAD 2)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  48:       }
> <@\textcolor{magenta}{49:       next\_top = curr\_top->next\_.load();}@>
  50:     } while (!top_.compare_exchange_weak(curr_top, next_top));

Local variables: 
curr_top = 0x7fc21bc96040
next_top = 0x100000002

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96010

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  49:       next_top = curr_top->next_.load();
> <@\textcolor{magenta}{50:     \} while (!top\_.compare\_exchange\_weak(curr\_top, next\_top));}@>
  51:     return curr_top;

Local variables: 
curr_top = 0x7fc21bc96040
next_top = 0x7fc21bc96010

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                    <@\textcolor{yellow}{RUN 13 (THREAD 1)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  15:     do {
> <@\textcolor{magenta}{16:       node->next\_.store(current\_top);}@>
  17:     } while (!top_.compare_exchange_weak(current_top, node));

Local variables: 
current_top = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96040
available = 0x2
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  16:       node->next_.store(current_top);
> <@\textcolor{magenta}{17:     \} while (!top\_.compare\_exchange\_weak(current\_top, node));}@>
  18:   }

Local variables: 
current_top = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96040
available = 0x2
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_weak(): succeeded = 1

Free(): after

Free(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 2}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			<@\textcolor{red}{[*] Blocks: -> B (0x7fc21bc96040) }@>
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		<@\textcolor{red}{[*] A (0x7fc21bc96070) : 1}@>
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  87:   void Free(Node* node) /*__attribute__((noinline))*/ {
> <@\textcolor{magenta}{88:     if (allocation\_count\_.load() == 0) \{}@>
  89:       item_list_.Push(node);

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 2

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 3}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> B (0x7fc21bc96040) 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  13:   void Push(Node* node) {
> <@\textcolor{magenta}{14:     Node* current\_top = top\_.load();}@>
  15:     do {

Local variables: 
current_top = 0x200413133

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96040

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 4}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> B (0x7fc21bc96040) 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  15:     do {
> <@\textcolor{magenta}{16:       node->next\_.store(current\_top);}@>
  17:     } while (!top_.compare_exchange_weak(current_top, node));

Local variables: 
current_top = 0x7fc21bc96040

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 5}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> B (0x7fc21bc96040) 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Push(Node*)
  16:       node->next_.store(current_top);
> <@\textcolor{magenta}{17:     \} while (!top\_.compare\_exchange\_weak(current\_top, node));}@>
  18:   }

Local variables: 
current_top = 0x7fc21bc96040

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Free(Node*)
  90:     } else {
> <@\textcolor{magenta}{91:       pending\_list\_.Push(node);}@>
  92:     }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  66:           Node* to_free = pool.Acquire(node_index);
> <@\textcolor{magenta}{67:           stack.Free(to\_free);}@>
  68:           SHOW_NOTE("Free(): after");

Local variables: 
to_free = 0x7fc21bc96070
available = 0x1
node_index = 0x0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_weak(): succeeded = 1

Free(): after

Alloc(): before

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 6}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			<@\textcolor{red}{[*] Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) }@>
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Top()
  38:   Node* Top() {
> <@\textcolor{magenta}{39:     return top\_.load();}@>
  40:   }

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  96:     // auto keep_count = pending_count_.load();
> <@\textcolor{magenta}{97:     Node* pending\_head = pending\_list\_.Top();}@>

Local variables: 
pending_head = 0x7fc21bc8cea0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96070

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 7}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) 
		    }

		    allocation_count_: 2
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{99:     if (allocation\_count\_.fetch\_add(1) == 0) \{}@>
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

fetch_add: prev = 2

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 8}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) 
		    }

		<@\textcolor{red}{[*] allocation\_count\_: 3}@>
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  42:   Node* Pop() {
> <@\textcolor{magenta}{43:     Node* curr\_top = top\_.load();}@>
  44:     Node* next_top;

Local variables: 
curr_top = 0x100000005
next_top = 0x100000002

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96010

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 9}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  48:       }
> <@\textcolor{magenta}{49:       next\_top = curr\_top->next\_.load();}@>
  50:     } while (!top_.compare_exchange_weak(curr_top, next_top));

Local variables: 
curr_top = 0x7fc21bc96010
next_top = 0x100000002

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                       <@\textcolor{cyan}{SNAPSHOT 10}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: -> C (0x7fc21bc96010) 
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 1
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  49:       next_top = curr_top->next_.load();
> <@\textcolor{magenta}{50:     \} while (!top\_.compare\_exchange\_weak(curr\_top, next\_top));}@>
  51:     return curr_top;

Local variables: 
curr_top = 0x7fc21bc96010
next_top = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_weak(): succeeded = 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			<@\textcolor{red}{[*] Blocks: }@>
		    }

		    Pending {
			    Blocks: -> A (0x7fc21bc96070) -> B (0x7fc21bc96040) 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		<@\textcolor{red}{[*] C (0x7fc21bc96010) : 0}@>
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{120:     allocation\_count\_.fetch\_sub(1);}@>

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7fc21bc96010

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                    <@\textcolor{yellow}{RUN 14 (THREAD 3)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::TryClear(Node*)
  55:     Node* desired = nullptr;
> <@\textcolor{magenta}{56:     return top\_.compare\_exchange\_strong(expected, desired);}@>
  57:   }

Local variables: 
desired = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  100:       if (pending_head != nullptr /*&& keep_count == pending_count_.load()*/
> <@\textcolor{magenta}{101:           \&\& pending\_list\_.TryClear(pending\_head)) \{}@>
  102:         auto head = pending_head;

Local variables: 
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_strong(): succeeded = 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 1}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: 
		    }

		    Pending {
			<@\textcolor{red}{[*] Blocks: }@>
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 0
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 1
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{104:         pending\_head = pending\_head->next\_.load();}@>
  105:         head->Release();

Local variables: 
head = 0x7fc21bc96070
pending_head = 0x7fc21bc96070
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0x7fc21bc96040

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 2}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 0
		    B (0x7fc21bc96040) : 1
		<@\textcolor{red}{[*] A (0x7fc21bc96070) : 0}@>
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Append(Node*)
  25:     Node* tail = head;
> <@\textcolor{magenta}{26:     Node* next = tail->next\_.load();}@>
  27:     while (next != nullptr) {

Local variables: 
tail = 0x7fc21bc96040
next = 0x7fc21baaa6a0
prev_top = 0x7fc21baaa690

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{107:         item\_list\_.Append(pending\_head);}@>
  108:         // pending_count_.fetch_add(1);

Local variables: 
head = 0x7fc21bc96070
pending_head = 0x7fc21bc96040
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 3}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 0
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Append(Node*)
> <@\textcolor{magenta}{32:     Node* prev\_top = top\_.load();}@>
  33:     do {

Local variables: 
tail = 0x7fc21bc96040
next = 0x0
prev_top = 0x7fc21baaa690

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{107:         item\_list\_.Append(pending\_head);}@>
  108:         // pending_count_.fetch_add(1);

Local variables: 
head = 0x7fc21bc96070
pending_head = 0x7fc21bc96040
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

load(): 0

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 4}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 0
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Append(Node*)
  33:     do {
> <@\textcolor{magenta}{34:       tail->next\_ = prev\_top;}@>
  35:     } while (!top_.compare_exchange_weak(prev_top, head));

Local variables: 
tail = 0x7fc21bc96040
next = 0x0
prev_top = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{107:         item\_list\_.Append(pending\_head);}@>
  108:         // pending_count_.fetch_add(1);

Local variables: 
head = 0x7fc21bc96070
pending_head = 0x7fc21bc96040
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                        <@\textcolor{cyan}{SNAPSHOT 5}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			    Blocks: 
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 0
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Append(Node*)
  34:       tail->next_ = prev_top;
> <@\textcolor{magenta}{35:     \} while (!top\_.compare\_exchange\_weak(prev\_top, head));}@>
  36:   }

Local variables: 
tail = 0x7fc21bc96040
next = 0x0
prev_top = 0x0

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{107:         item\_list\_.Append(pending\_head);}@>
  108:         // pending_count_.fetch_add(1);

Local variables: 
head = 0x7fc21bc96070
pending_head = 0x7fc21bc96040
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_weak(): succeeded = 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			<@\textcolor{red}{[*] Blocks: -> B (0x7fc21bc96040) }@>
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 0
		    B (0x7fc21bc96040) : 1
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
  108:         // pending_count_.fetch_add(1);
> <@\textcolor{magenta}{109:         allocation\_count\_.fetch\_sub(1);}@>

Local variables: 
head = 0x7fc21bc96070
pending_head = 0x7fc21bc96040
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x0
node_index = 0xffffffff

<@\textcolor{yellow}{==========================================================================================}@>
                                    <@\textcolor{yellow}{RUN 15 (THREAD 2)}@>
<@\textcolor{yellow}{==========================================================================================}@>

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{BEFORE}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LockFreeStack::Pop()
  49:       next_top = curr_top->next_.load();
> <@\textcolor{magenta}{50:     \} while (!top\_.compare\_exchange\_weak(curr\_top, next\_top));}@>
  51:     return curr_top;

Local variables: 
curr_top = 0x7fc21bc96040
next_top = 0x7fc21bc96010

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{115:     auto node = item\_list\_.Pop();}@>
  116:     if (node != nullptr) {

Local variables: 
pending_head = 0x0
node = 0x7ffd4ad1d480

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                         <@\textcolor{cyan}{RUNNING}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

compare_exchange_weak(): succeeded = 1

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
                                          <@\textcolor{cyan}{AFTER}@>
<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>

<@\textcolor{red}{SHARED STATE:}@>

    LFAlloc {
	    LFStack {
		    Head {
			<@\textcolor{red}{[*] Blocks: -> C (0x7fc21bc96010) }@>
		    }

		    Pending {
			    Blocks: 
		    }

		    allocation_count_: 3
	    }

	    Memory {
		    C (0x7fc21bc96010) : 0
		<@\textcolor{red}{[*] B (0x7fc21bc96040) : 0}@>
		    A (0x7fc21bc96070) : 0
	    }

    }

<@\textcolor{cyan}{------------------------------------------------------------------------------------------}@>
<@\textcolor{magenta}{
STACK:
}@>
Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/alloc_lfstack.hpp",
in LFAllocator::Alloc()
> <@\textcolor{magenta}{120:     allocation\_count\_.fetch\_sub(1);}@>

Local variables: 
pending_head = 0x0
node = 0x7fc21bc96040

<@\textcolor{cyan}{----------------}@>

Object "/home/sham42/git/twist-mc-test/tests/alloc_lfstack3/test.cpp",
in operator()
  61:           SHOW_NOTE("Alloc(): before");
> <@\textcolor{magenta}{62:           stack.Alloc();}@>
  63:           SHOW_NOTE("Alloc(): after");

Local variables: 
available = 0x1
node_index = 0xffffffff

<@\textcolor{red}{==========================================================================================}@>
                                     <@\textcolor{red}{ASSERTION FAILED}@>
<@\textcolor{red}{==========================================================================================}@>

ItemList: assertion failed
<@\textcolor{red}{
==========================================================================================
}@>

\end{lstlisting}

\end{multicols*}

\end{allintypewriter}

\end{adjustwidth}


